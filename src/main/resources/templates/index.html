<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Postman → Swagger Converter</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
    <style>
        :root { --postman-color:#ef5b25; --swagger-color:#49cc90; --bg-dark:#1e1e2e; }
        body { background:#f5f6fa; font-family:'Segoe UI',system-ui,sans-serif; }

        .hero { background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%); color:white; padding:2.5rem 0 1.5rem; }
        .hero h1 { font-size:2rem; font-weight:700; }
        .hero .subtitle { color:#a0aec0; font-size:0.95rem; }

        .upload-card { border:2px dashed #cbd5e0; border-radius:12px; transition:border-color .2s; }
        .upload-card:hover { border-color:#667eea; }

        .tab-toggle .btn { border-radius:8px; font-size:0.875rem; }
        .tab-toggle .btn.active { background:#667eea; color:white; border-color:#667eea; }

        textarea.code-input { font-family:'Courier New',monospace; font-size:0.8rem;
            background:var(--bg-dark); color:#cdd6f4; border:none; resize:vertical; border-radius:8px; }

        .token-card { border-radius:12px; padding:1.25rem 1.5rem; text-align:center;
            border:1px solid rgba(0,0,0,.06); background:white; }
        .token-card .token-num { font-size:2.2rem; font-weight:800; line-height:1; }
        .token-card .token-label { font-size:0.75rem; text-transform:uppercase;
            letter-spacing:.05em; color:#6b7280; margin-top:.25rem; }
        .card-postman .token-num { color:var(--postman-color); }
        .card-swagger .token-num { color:#059669; }
        .card-diff .token-num { color:#7c3aed; }
        .card-diff { background:linear-gradient(135deg,#f5f3ff,#ede9fe); border-color:#c4b5fd; }

        .savings-bar-wrap { background:#e5e7eb; border-radius:999px; height:10px; overflow:hidden; }
        .savings-bar { height:100%; border-radius:999px;
            background:linear-gradient(90deg,#059669,#10b981); transition:width .6s ease; }
        .savings-bigger { background:linear-gradient(90deg,#dc2626,#ef4444); }

        .code-panel { background:var(--bg-dark); border-radius:12px; overflow:hidden; }
        .code-panel-header { display:flex; justify-content:space-between; align-items:center;
            padding:.65rem 1rem; background:rgba(255,255,255,.06); border-bottom:1px solid rgba(255,255,255,.08); }
        .code-panel-header span { color:#cdd6f4; font-size:.8rem; font-weight:600; letter-spacing:.04em; }
        .code-scroll { overflow-y:auto; max-height:500px; }
        pre { margin:0; padding:1rem; font-size:.775rem; line-height:1.6; color:#cdd6f4;
            font-family:'Courier New',monospace; white-space:pre-wrap; word-break:break-all; }
        .btn-copy { background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.15);
            color:#cdd6f4; font-size:.75rem; padding:.25rem .65rem; border-radius:6px;
            cursor:pointer; transition:background .15s; }
        .btn-copy:hover { background:rgba(255,255,255,.2); }
        .note-box { background:#fffbeb; border-left:4px solid #f59e0b; border-radius:0 8px 8px 0;
            padding:.65rem 1rem; font-size:.82rem; color:#78350f; }
    </style>
</head>
<body>

<div class="hero">
    <div class="container">
        <h1>
            <span class="badge me-2" style="background:var(--postman-color);font-size:.55em;vertical-align:middle;">POSTMAN</span>
            → Swagger / OpenAPI Converter
        </h1>
        <p class="subtitle mb-0">Converts a Postman collection to OpenAPI 3.0 YAML &amp; estimates the Claude Code token difference.</p>
    </div>
</div>

<div class="container py-4">

    <!-- Error -->
    <div th:if="${error}" class="alert alert-danger d-flex align-items-center gap-2 mb-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <span th:text="${error}"></span>
    </div>

    <!-- Input form -->
    <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-body p-4">
            <h5 class="fw-semibold mb-3"><i class="bi bi-upload me-2 text-primary"></i>Postman Collection Input</h5>
            <form th:action="@{/convert}" method="post" enctype="multipart/form-data" id="convertForm">

                <div class="tab-toggle btn-group mb-3" role="group">
                    <button type="button" class="btn btn-outline-secondary active" onclick="showTab('paste')">
                        <i class="bi bi-clipboard me-1"></i>Paste JSON
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="showTab('file')">
                        <i class="bi bi-file-earmark-arrow-up me-1"></i>Upload File
                    </button>
                </div>

                <div id="tab-paste">
                    <textarea name="postmanJson" id="postmanJson" class="form-control code-input"
                              rows="14" placeholder="Paste your Postman Collection v2.0 / v2.1 JSON here…"
                              th:text="${postmanInput}"></textarea>
                </div>

                <div id="tab-file" style="display:none">
                    <div class="upload-card p-4 text-center">
                        <i class="bi bi-file-earmark-code display-5 text-secondary mb-2"></i>
                        <p class="mb-2 text-muted">Drop a <code>.json</code> file or click to browse</p>
                        <input type="file" name="file" accept=".json,application/json"
                               class="form-control" style="max-width:300px;margin:0 auto"/>
                    </div>
                </div>

                <div class="d-flex align-items-center gap-3 mt-3">
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="bi bi-arrow-right-circle me-2"></i>Convert
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                        <i class="bi bi-x-circle me-1"></i>Clear
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Results (all expressions use pre-computed fields — no OGNL arithmetic) -->
    <div th:if="${result}">

        <div class="d-flex align-items-center gap-2 mb-3">
            <i class="bi bi-collection-fill text-primary fs-5"></i>
            <h5 class="mb-0 fw-bold" th:text="${result.collectionName}"></h5>
        </div>

        <!-- Token stat cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="token-card card-postman h-100">
                    <div class="token-num" th:text="${#numbers.formatInteger(result.postmanTokens, 1, 'COMMA')}"></div>
                    <div class="token-label">Postman JSON tokens</div>
                    <small class="text-muted d-block mt-1" th:text="${result.postmanChars + ' chars'}"></small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="token-card card-swagger h-100">
                    <div class="token-num" th:text="${#numbers.formatInteger(result.swaggerTokens, 1, 'COMMA')}"></div>
                    <div class="token-label">OpenAPI YAML tokens</div>
                    <small class="text-muted d-block mt-1" th:text="${result.swaggerChars + ' chars'}"></small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="token-card card-diff h-100">
                    <div class="token-num" th:text="${#numbers.formatInteger(result.tokenDifference, 1, 'COMMA')}"></div>
                    <div class="token-label">Token difference</div>
                    <small class="d-block mt-1 fw-semibold"
                           th:classappend="${result.swaggerSmaller ? 'text-success' : 'text-danger'}"
                           th:text="'Swagger ' + ${result.savingsVerb} + ' ' + ${result.reductionPct} + '%'"></small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="token-card h-100 d-flex flex-column justify-content-center">
                    <div class="token-label mb-2">Token reduction</div>
                    <div class="savings-bar-wrap mb-1">
                        <div class="savings-bar"
                             th:classappend="${result.swaggerSmaller ? '' : 'savings-bigger'}"
                             th:style="'width:' + ${result.barWidth} + '%'"></div>
                    </div>
                    <small class="text-muted text-center"
                           th:text="${result.swaggerSmaller ? 'Swagger is more compact' : 'Swagger is larger'}"></small>
                </div>
            </div>
        </div>

        <div class="note-box mb-4">
            <i class="bi bi-info-circle me-1"></i>
            <strong>Token estimation:</strong>
            Approximated at <strong>~3.5 chars/token</strong> — realistic for structured JSON/YAML with Claude's BPE tokenizer. Actual counts may vary ±15%.
        </div>

        <!-- Side-by-side code panels -->
        <div class="row g-3">
            <div class="col-lg-6">
                <div class="code-panel">
                    <div class="code-panel-header">
                        <span>
                            <i class="bi bi-filetype-json me-1" style="color:var(--postman-color)"></i>
                            Postman Collection JSON &nbsp;
                            <span class="badge" style="background:var(--postman-color);font-size:.7em"
                                  th:text="${#numbers.formatInteger(result.postmanTokens, 1, 'COMMA') + ' tokens'}"></span>
                        </span>
                        <button class="btn-copy" onclick="copyCode('postman-code', this)">
                            <i class="bi bi-clipboard me-1"></i>Copy
                        </button>
                    </div>
                    <div class="code-scroll">
                        <pre id="postman-code" th:text="${result.postmanJson}"></pre>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="code-panel">
                    <div class="code-panel-header">
                        <span>
                            <i class="bi bi-filetype-yml me-1" style="color:var(--swagger-color)"></i>
                            OpenAPI 3.0 YAML &nbsp;
                            <span class="badge" style="background:var(--swagger-color);color:#000;font-size:.7em"
                                  th:text="${#numbers.formatInteger(result.swaggerTokens, 1, 'COMMA') + ' tokens'}"></span>
                        </span>
                        <button class="btn-copy" onclick="copyCode('swagger-code', this)">
                            <i class="bi bi-clipboard me-1"></i>Copy
                        </button>
                    </div>
                    <div class="code-scroll">
                        <pre id="swagger-code" th:text="${result.swaggerYaml}"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    function showTab(tab) {
        document.getElementById('tab-paste').style.display = tab === 'paste' ? '' : 'none';
        document.getElementById('tab-file').style.display  = tab === 'file'  ? '' : 'none';
        document.querySelectorAll('.tab-toggle .btn').forEach((b, i) => {
            b.classList.toggle('active', (tab === 'paste' && i === 0) || (tab === 'file' && i === 1));
        });
    }
    function clearForm() {
        document.getElementById('postmanJson').value = '';
        document.querySelectorAll('input[type=file]').forEach(f => f.value = '');
    }
    function copyCode(id, btn) {
        navigator.clipboard.writeText(document.getElementById(id).textContent).then(() => {
            btn.innerHTML = '<i class="bi bi-check2 me-1"></i>Copied!';
            setTimeout(() => btn.innerHTML = '<i class="bi bi-clipboard me-1"></i>Copy', 2000);
        });
    }
</script>
</body>
</html>
